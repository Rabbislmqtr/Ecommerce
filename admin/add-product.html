<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Add Product - Admin</title>
  <link rel="stylesheet" href="../css/admin.css">
</head>
<body>
  <div class="admin-container">
    <aside class="admin-sidebar">
      <div class="admin-logo">
        <h2>FashionHub Admin</h2>
      </div>
      <nav class="admin-nav">
        <a href="index.html"><span>üìä</span> Dashboard</a>
        <a href="products.html" class="active"><span>üõçÔ∏è</span> Products</a>
        <a href="orders.html"><span>üì¶</span> Orders</a>
        <a href="analytics.html"><span>üìà</span> Analytics</a>
        <a href="settings.html"><span>‚öôÔ∏è</span> Settings</a>
      </nav>
    </aside>

    <main class="admin-main">
      <header class="admin-header">
        <h1>Add New Product</h1>
        <div class="admin-user">
          <span id="admin-name">Admin</span>
          <button class="btn btn-secondary btn-sm" id="admin-logout">Logout</button>
        </div>
      </header>

      <div class="admin-content">
        <div class="card">
          <form id="add-product-form">
            <div class="form-row">
              <div class="form-group">
                <label>Product Name *</label>
                <input type="text" class="form-control" id="product-name" required>
              </div>
              <div class="form-group">
                <label>SKU *</label>
                <input type="text" class="form-control" id="product-sku" required>
              </div>
            </div>

            <div class="form-row">
              <div class="form-group">
                <label>Category *</label>
                <select class="form-control" id="product-category" required>
                  <option value="">Select Category</option>
                  <option value="dresses">Dresses</option>
                  <option value="tops">Tops</option>
                  <option value="bottoms">Bottoms</option>
                  <option value="outerwear">Outerwear</option>
                  <option value="accessories">Accessories</option>
                </select>
              </div>
              <div class="form-group">
                <label>Price *</label>
                <input type="number" class="form-control" id="product-price" step="0.01" required>
              </div>
            </div>

            <div class="form-group">
              <label>Description *</label>
              <textarea class="form-control" id="product-description" rows="4" required></textarea>
            </div>

            <div class="form-row">
              <div class="form-group">
                <label>Stock Quantity *</label>
                <input type="number" class="form-control" id="product-stock" value="100" required>
              </div>
              <div class="form-group">
                <label>In Stock</label>
                <select class="form-control" id="product-instock">
                  <option value="true">Yes</option>
                  <option value="false">No</option>
                </select>
              </div>
            </div>

            <div class="form-group">
              <label>Available Sizes *</label>
              <div class="checkbox-group">
                <label class="checkbox-label">
                  <input type="checkbox" value="XS" class="size-checkbox"> XS
                </label>
                <label class="checkbox-label">
                  <input type="checkbox" value="S" class="size-checkbox"> S
                </label>
                <label class="checkbox-label">
                  <input type="checkbox" value="M" class="size-checkbox"> M
                </label>
                <label class="checkbox-label">
                  <input type="checkbox" value="L" class="size-checkbox"> L
                </label>
                <label class="checkbox-label">
                  <input type="checkbox" value="XL" class="size-checkbox"> XL
                </label>
                <label class="checkbox-label">
                  <input type="checkbox" value="XXL" class="size-checkbox"> XXL
                </label>
                <label class="checkbox-label">
                  <input type="checkbox" value="One Size" class="size-checkbox"> One Size
                </label>
              </div>
            </div>

            <div class="form-group">
              <label>Available Colors *</label>
              <div class="checkbox-group">
                <label class="checkbox-label">
                  <input type="checkbox" value="Black" class="color-checkbox"> Black
                </label>
                <label class="checkbox-label">
                  <input type="checkbox" value="White" class="color-checkbox"> White
                </label>
                <label class="checkbox-label">
                  <input type="checkbox" value="Red" class="color-checkbox"> Red
                </label>
                <label class="checkbox-label">
                  <input type="checkbox" value="Blue" class="color-checkbox"> Blue
                </label>
                <label class="checkbox-label">
                  <input type="checkbox" value="Navy" class="color-checkbox"> Navy
                </label>
                <label class="checkbox-label">
                  <input type="checkbox" value="Pink" class="color-checkbox"> Pink
                </label>
                <label class="checkbox-label">
                  <input type="checkbox" value="Beige" class="color-checkbox"> Beige
                </label>
                <label class="checkbox-label">
                  <input type="checkbox" value="Gray" class="color-checkbox"> Gray
                </label>
                <label class="checkbox-label">
                  <input type="checkbox" value="Brown" class="color-checkbox"> Brown
                </label>
              </div>
            </div>

            <div class="form-group">
              <label>Product Images *</label>
              <div class="image-upload-area" id="image-upload-area">
                <p>Click to upload or drag and drop</p>
                <p style="font-size: 12px; color: #666;">PNG, JPG, WEBP (Max 5MB each)</p>
                <input type="file" id="product-images" accept="image/*" multiple style="display: none;">
              </div>
              <div id="image-preview-container" class="image-preview-container"></div>
            </div>

            <div class="form-group">
              <button type="submit" class="btn btn-primary">Add Product</button>
              <a href="products.html" class="btn btn-secondary">Cancel</a>
            </div>
          </form>
        </div>
      </div>
    </main>
  </div>

  <script src="../js/utils.js"></script>
  <script src="../js/auth.js"></script>
  <script src="../js/products.js"></script>
  <script src="../js/admin/admin-app.js"></script>
  <script src="../js/admin/image-upload.js"></script>
  <script src="../js/admin/admin-products.js"></script>
  <script>
    let uploadedImages = [];

    // Initialize after DOM is ready
    function initializePage() {
      if (!AdminAuth.init()) {
        return;
      }

      initImageUpload();
    }

    function initImageUpload() {
      const uploadArea = document.getElementById('image-upload-area');
      const fileInput = document.getElementById('product-images');
      const previewContainer = document.getElementById('image-preview-container');

      if (!uploadArea || !fileInput || !previewContainer) {
        console.error('Required upload elements not found');
        return;
      }

      // Click to upload
      uploadArea.addEventListener('click', () => {
        fileInput.click();
      });

      // Drag and drop functionality
      uploadArea.addEventListener('dragover', (e) => {
        e.preventDefault();
        e.stopPropagation();
        uploadArea.style.backgroundColor = '#f0f0f0';
        uploadArea.style.borderColor = '#007bff';
      });

      uploadArea.addEventListener('dragleave', (e) => {
        e.preventDefault();
        e.stopPropagation();
        uploadArea.style.backgroundColor = '';
        uploadArea.style.borderColor = '';
      });

      uploadArea.addEventListener('drop', async (e) => {
        e.preventDefault();
        e.stopPropagation();
        uploadArea.style.backgroundColor = '';
        uploadArea.style.borderColor = '';

        const files = Array.from(e.dataTransfer.files).filter(file => file.type.startsWith('image/'));
        await processFiles(files);
      });

      // File input change
      fileInput.addEventListener('change', async (e) => {
        const files = Array.from(e.target.files);
        await processFiles(files);
      });

      // Process files function
      async function processFiles(files) {
        if (files.length === 0) {
          Utils.showToast('No images selected', 'error');
          return;
        }

        for (const file of files) {
          try {
            console.log('Processing file:', file.name);
            const base64 = await ImageUpload.convertToBase64(file);
            uploadedImages.push(base64);

            const preview = ImageUpload.createPreview(base64, () => {
              const index = uploadedImages.indexOf(base64);
              if (index > -1) uploadedImages.splice(index, 1);
            });

            previewContainer.appendChild(preview);
            Utils.showToast(`Image "${file.name}" uploaded successfully`, 'success');
          } catch (error) {
            console.error('Error processing file:', error);
            Utils.showToast(error.message, 'error');
          }
        }
      }
    }

    // Run after DOM is loaded
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', initializePage);
    } else {
      initializePage();
    }

    document.getElementById('add-product-form').addEventListener('submit', (e) => {
      e.preventDefault();

      const sizes = Array.from(document.querySelectorAll('.size-checkbox:checked')).map(cb => cb.value);
      const colors = Array.from(document.querySelectorAll('.color-checkbox:checked')).map(cb => cb.value);

      if (sizes.length === 0) {
        Utils.showToast('Please select at least one size', 'error');
        return;
      }

      if (colors.length === 0) {
        Utils.showToast('Please select at least one color', 'error');
        return;
      }

      if (uploadedImages.length === 0) {
        Utils.showToast('Please upload at least one image', 'error');
        return;
      }

      const formData = {
        name: document.getElementById('product-name').value,
        sku: document.getElementById('product-sku').value,
        category: document.getElementById('product-category').value,
        price: document.getElementById('product-price').value,
        description: document.getElementById('product-description').value,
        stock: document.getElementById('product-stock').value,
        inStock: document.getElementById('product-instock').value === 'true',
        sizes,
        colors,
        image: uploadedImages[0],
        images: uploadedImages
      };

      AdminProducts.handleAddProduct(formData);
    });
  </script>
</body>
</html>
